# [КАТОМКА]: Руководство по сборке образа среды разработки Entware для сборки отдельных пакетов на С и С++ для роутеров Keenetic

## Принципы сборки, запуска среды разработки
1. Сборка **docker**-образа среды сборки пакета должна осуществляется на многоядерном компьютере с целью снижения времени сборки пакета.
2. Сборка пакета осуществляется **под пользователем отличным от root**, а файлы проекта должны находиться в одной из папок домашней директории.
3. Установка уже собранного пакета осуществляется на удаленном роутере для которого Вам необходимо ввести данные в файл **./build/CONFIG**
4. Тестирование разрабатываемого пакета осуществляется на устройстве разработки при уже собранном и установленном пакете на удаленном роутере 
5. Работа с исходниками проекта и внесение в него своих правок осуществляется на компьютере (в привычной Вам **IDE**), но сама сборка пакета осуществляется в **docker**-контейнере на основе собранного **docker**-образа.
6. Все первоначальные настройки осуществляются в файле **./build/CONFIG** (см. описание ниже по тексту).

## Структура файлов
```
   /apps/katomka/                         - папка настоящего проекта (имя папки необходимо изменить на имя разработываемого Вами пакета).
          ├──README.md                    - настоящий файл справки  
          ├──LICENCE.md                   - файл с описанием лицензии по которой распространяется данный проект.
          ├──/build/                      - папка для сборки проекта
          |    ├─/docker/
          |    |    ├──docker-compose.yml - файл сборки docker-образа и запуска контейнера после сборки (ручной режим)    
          |    |    ├──.env               - файл содержит переменные среды окружения docker-образа (создается автоматически)
          |    |    └──Dockerfile         - файл в котором содержится информация по сборке docker-образа среды разработки Entware для роутеров Keenetic
          |    ├─/make/
          
          
          |    ├──Makefile.build - файл создания файла Makefile для сборки пакета Квас
          |    ├──Makefile       - полученый в результате исполнения скрипта Makefile.build файл Makefile 
          |    ├──app.make       - СКРИПТ для сборки пакета после его изменений (описание ключей ниже)
          |    ├──library.run    - файл библиотеки, который содержит функции и используется для firstrun.build
          |    ├──firstrun.build - файл первоначальной сборки пакета kvas внутри запущенного контейнера, 
          |    |                   который запускает make tools и toolchain (запускается из ../image.build)
          |    ├──package.build  - файл первоначальной сборки пакета kvas внутри запущенного контейнера, 
          |    |                   который запускает сборку уже самого пакета Квас (запускается из ./app.make с ключем build)
          |    ├──copy.build     - файл копирования пакета kvas на роутер внутри запущенного контейнера, в случае, если нужно просто 
          |    |                   произвести копирование уже собранного пакета на роутер (запускается из ./app.make с ключем copy)
          |    ├──postinst       - файл содержащий скрипты для первичной установки пакета квас на роутере при команде opkg install. Используется при сборке в файле Makefile.build
          |    ├──postterm       - файл содержащий скрипты для удаления пакета квас на роутере при команде opkg remove. Используется при сборке в файле Makefile.build
          |    ├──CONFIG         - файл конфигурации, который необходимо заполнить перед началом работы над пакетом.
          |    └──README.md      - настоящий файл справки 
          └──/code/ 
               ├──main.cpp       - начальный файл Вашего проекта на C++ с выводом "Здравствуй Мир!"
               └──Makefile       - 
```

## Сборка docker-образа
1. [Устанавливаем Docker](https://docs.docker.com/engine/install/), если его нет на устройстве разработки
2. Создаем папку **./apps** на устройстве разработки, где будет осуществляться сборка docker-образа
3. Клонируем исходники из [github](https://github.com/qzeleza/katomka) и переименовываем папку ./apps/katomka/ на имя своего разрабатываемого проекта.
```
mkdir ./apps 
git clone https://github.com/qzeleza/kvas.git
mv ./apps/katomka ./apps/<имя_пакета>
```

4. Редактируем файл **./build/CONFIG**
5. Запускаем сборку docker-образа в автоматическом режиме посредством файла **image.build**
    - в случае необходимости вводим запрашиваемые данные для доступа к роутеру на котором будет устанавливаться и тестироваться пакет

```
cd <корневая папка>/apps/<имя_пакета>/
./image.build
```
#### ДЛЯ СПРАВКИ!
_В зависимости от мощности процессора устройства, на котором происходит сборка docker-образа, 
работа по его настройке и упаковке может занять от **20** мин. до **2** часов, а размер готового образа составляет, как минимум **10Gb**_


## Сборка пакета
1. Правим, в случае необходимости, исходные файлы в папке **/apps/kvas/opt** под свои потребности.
2. Правим файл **./build/version** - задаем необходимый номер релиза и версии пакета 
3. Запускаем сборку пакета командой **./build/app.make build**
   - Запустится сборка контейнера и сразу откроется контейнер, в случае, если он уже был ранее собран и запустится процесс сборки пакета.
   - Далее, последует удаление пакета на роутере и его последующая установка

При необходимости можно просто скопировать уже собранный пакет на роутер или зайти в контейнер для работы (см. команды ниже);

### Описание параметров запуска утилиты **./build/app.make**
| Команда        | Аргументы |
|----------------|:---------:|
| app.make build |     -     |
| app.make copy  |     -     |
| app.make term  |     -     |

```

build - сборка пакета и копирование его на роутер
copy  - копирование уже собранного пакета на роутер
term  - подключение к контейнеру без исполнения скриптов

```


