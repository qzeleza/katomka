# КАТОМКА :: Пакет скриптов по быстрому развертыванию среды разработки Entware в Docker-контейнере для роутеров Keenetic с целью сборки пакетов на языках семейства Bash, С, С++.

```
Данный пакет служит прежде всего для тех разработчиков, которые хотят быстро осуществить сборку своего пакета 
для роутеров Kennetic на таких языках программирования, как **С**, **С++** и на семействе языков **Bash**.

Установка данного пакета на хост-машину позволит быстро собрать Вам необходимый docker-образ со средой разработки 
под Entware для роутеров Keenetic с программой-примером, которая, при ее запуске, выведет в консоль роутера 
"Здравствуй Мир!".

После чего Вы уже самостоятельно сможете под свои нужды модифицировать данный пример и расширять его, по мере 
необходимости, используя свою IDE и запуская сборку внутри запущенного контейнера с автоматическим удалением 
старого пакета и установкой новой версии пакета на удаленное устройство.
```
---

### Автор проекта: [Zeleza](mail@zeleza.ru)
Разработка проекта ведется с использованием IDE от компании [JetBrains](https://www.jetbrains.com/ru-ru/).

---

## Преимущества пакета
1. Быстрое развертывание среды разработки для роутеров Keenetic в Entware - от 12 минут.
2. Нет необходимости заходить внутрь контейнера, так как сборка и копирование собранного пакета делается автоматически.
3. Нет необходимости в принципе разбираться с работой Docker-а, так как сборка образа, его монтирование и подключение к нему происходит автоматически.
4. Возможность писать тесты для приложения и исполнять их на удаленном устройстве сразу после установки пакета.
5. Моментальное подключение и вход в собранный docker-контейнер в случае необходимости. 

## Известные недостатки
1. Работает только на **MAC OS X** или **Linux**
2. 

---

## Основные принципы сборки среды разработки.
1. Сборка **docker**-образа среды сборки пакета должна осуществляется на многоядерном компьютере с предустановленной **MAC OS X** или **Linux** ОС.
2. Сборка пакета осуществляется **под пользователем отличным от root**, а файлы проекта должны находиться в одной из папок домашней директории.
3. Установка уже собранного пакета осуществляется на удаленном роутере для которого Вам необходимо ввести данные в файл **./build/CONFIG**
4. Тестирование разрабатываемого пакета осуществляется на устройстве разработки при уже собранном и установленном пакете на удаленном роутере 
5. Работа с исходниками проекта и внесение в него своих правок осуществляется на компьютере (в привычной Вам **IDE**), но сама сборка пакета осуществляется в **docker**-контейнере на основе собранного **docker**-образа.
6. Все первоначальные настройки осуществляются в файле **./build/CONFIG** (см. описание ниже по тексту).

## Структура файлов проекта на хостовой машине.
```
   /apps/kotomka/                          - папка настоящего проекта (имя папки необходимо изменить на имя 
          |                                  разработываемого Вами пакета).
          ├──LICENCE.md                    - файл с описанием лицензии по которой распространяется данный проект.
          ├──.gitignore                    - файл содержащий фильтры при сохранении измений в git для настоящего проекта.
          ├──/ipk/                         - папка, в которой будут сохраняться собранные ipk пакеты, после их сборки. 
          |
------------------------------------------- Директория проекта КАТОМКА -----------------------------------------------------
          |
          ├──/build/                       - папка для сборки проекта
          |    |
          |    ├──README.md                - настоящий файл справки  
          |    ├──version                  - файл с данными о текущей версии разработаываемого приложения.
          |    ├──kotomka                  - ОСНОВНОЙ файл запуска сборки образа, контейнера и самого приложения в нем 
          |    |                             (запускается на хостовой машине).
          |    ├──/docker/                 - папка, которая содержит файлы относящиеся к работе с docker и docker-compose
          |    |    ├──docker-compose.yml  - файл сборки docker-образа и запуска контейнера после сборки (ручной режим)    
          |    |    ├──.env                - файл содержит переменные среды окружения docker-образа (создается автоматически)
          |    |    └──Dockerfile          - файл в котором содержится информация по сборке docker-образа среды разработки 
          |    |                             Entware для роутеров Keenetic
          |    ├──/scripts/                - все скрипты в этой папке запускаются внутри контейнера. 
          |    |    ├──library             - файл, который содержит библиотечные функции     
          |    |    ├──package.app         - скрипт, который запускается для сборки пакета.
          |    |    └──copy.app            - скрипт, который вызывается для запуска процесса копирования собранного и 
          |    |                             упакованного пакета на роутер 
          |    └──/.templates/             - папка, которая содержит шаблоны файлов для сборки пакета под различные 
          |         |                        языки разработки. 
          |         ├──/code/              - папка, которая содержит файлы-исходники под различные языки разработки.  
          |         |     ├──main.c        - исходный код примера на Си с функцией вывода в консоль "Здравствуй, Мир!".
          |         |     ├──main.cpp      - исходный код примера на С++ с функцией вывода в консоль "Здравствуй, Мир!".  
          |         |     └──main.sh       - исходный код примера на Bash с функцией вывода в консоль "Здравствуй, Мир!".
          |         | 
          |         ├──/compile/           - папка, которая содержит ШАБЛОНЫ файлов манифеста Makefile  
          |         |     |                  и скрипты postinst и postrm, используемые для сборки пакета. 
          |         |     ├──postinst      - скрипт, который исполняется при установке пакета командой 'opkg install'
          |         |     ├──postrm        - скрипт, который исполняется при удалении пакета командой 'opkg remove'  
          |         |     ├──Manifest.bash - файл манифеста, на основании которого собирается пакет для языка Bash.
          |         |     ├──Manifest.cpp  - файл манифеста, на основании которого собирается пакет для языка С++.  
          |         |     └──Manifest.c    - файл манифеста, на основании которого собирается пакет для языка Си.
          |         |
          |         └──/make/              - папка, которая содержит файлы make для компиляции пакета под Си и С++.
          |               ├──Makefile.cpp  - Makefile файл для компиляции и линковки примера программы для языка С++.  
          |               └──Makefile.c    - Makefile файл для компиляции и линковки примера программы для языка Си.
          |
------------------------------------------- Директории c исходным кодом  ----------------------------------------------------    
          |
          ├──/opt/                         - папка, в которой могут находиться различные файлы-скрипты, которые требуются для 
          |                                  установки на роутер в оотвествующую папку. Здесь, папки можно добавлять по своему
          |                                  усмотрению, они должны соотвествовать файловой структуре на роутере.  
          ├──/code/                        - папка, в котрой находятся все файлы-исходники разрабатываемого проекта. 
          |    |                             В этой папке файлы создаются после запуска команды сборки проекта или если 
          |    |                             Вы их добавите самостоятельно. Их можно и нужно редактировать в своей IDE.
          |    ├──main.*|<имя проекта>     - файл с именем main.* для Си и С++ или файл с именем проекта для Bash.    
          |    └──Makefile                 - Makefile файл для компиляции и линковки для Си и С++. Для Bash - не создается.
          |
          └──/compile/                     - папка, в котрой находятся файлы манифеста Makefile и скрипты postinst и postrm, 
               |                             используемые для сборки пакета (появляются только после запуска ./build/kotomka). 
               |                             Здесь их можно редактировать в своей IDE.
               ├──postinst                 - скрипт пост-установки пакета. Редактируете в случае необходимости.
               ├──postrm                   - скрипт пост-удаления пакета. Редактируете в случае необходимости.  
               └──Manifest.*               - файл манифеста для каждого языка разработки со своим расширением. 
                                             Данный файл подлежит редактированию кроме переменных начинающихся с @.
                                             Значния этих переменных необходимо редактировать в файле ./build/CONFIG
```

## Подготовительные действия
1. [Устанавливаем Docker](https://docs.docker.com/engine/install/), если его нет на устройстве разработки
2. Создаем папку **./apps** на устройстве разработки, где будет осуществляться сборка docker-образа
3. Клонируем исходники из [github](https://github.com/qzeleza/kotomka)
4. Переименовываем папку с названием **./kotomka** на имя своего разрабатываемого проекта.
5. Переходим в папку сборки образа ./apps/<имя_пакета>/build
```
mkdir ./apps 
git clone https://github.com/qzeleza/kotomka.git
mv ./apps/kotomka ./apps/<имя_пакета>
cd ./apps/<имя_пакета>/build
```

#### ДЛЯ СПРАВКИ!
_В зависимости от мощности процессора устройства, на котором происходит сборка docker-образа, 
работа по его настройке и упаковке может занять продолжительное время, а сам размер готового образа составляет, как минимум **10Gb**_


## Первоначальная сборка пакета
1. Редактируем файл конфигурации **./build/CONFIG**. В комментариях к каждой записи Вы сможете найти пояснения.
2. Запускаем сборку docker-образа/контейнера в автоматическом режиме посредством файла `./kotomka build`
   - можно воспользоваться командой `./kotomka make` для последующей сборки самого пакета
   - в случае необходимости, можно сразу запустить сборку в режиме отладки командой `./kotomka make debug`
3. После сборки образа, контейнера и самого пакета, автоматически произойдет копирование собранного пакета на Ваше устройство, с целью проверки работы.
4. При осуществлении первого копирования на устройство, необходимо ввести дважды пароль на Ваше устройство и после копирования ключей и самого пакета он будет автоматически установлен.
5. Затем, необходимо перейти на само устройство в терминале и запустить Ваш пакет командой **<имя_пакета>**
6. Результатом должна будет появиться строка в консоли "Здравствуй Мир!"


## Дальнейшая разработка пакета
1. Правим, по необходимости, исходные файлы в папке **./apps/<имя_пакета>/code** под свои потребности.
2. Правим файл **./apps/<имя_пакета>/build/version** - задаем необходимый номер релиза и версии пакета.
3. Правим, по необходимости, файл манифеста **./apps/<имя_пакета>/compile/Makefile.<c|cpp|sh>**
4. Правим, по необходимости, скрипт **./apps/<имя_пакета>/compile/postinst**, исполняемый при установке пакета командой `opkg install <ваш_ipk_пакет>`
5. Правим, по необходимости, скрипт **./apps/<имя_пакета>/compile/postrm**, исполняемый при удалении пакета командой `opkg remove <имя_вашего_пакета>`
6. Запускаем сборку пакета командой **./apps/<имя_пакета>/build/kotomka make**
   - Запустится сборка образа (если он не был собран ранее), и затем, запустится процесс сборки пакета.
   - Далее, последует удаление пакета на роутере и его последующая установка.
   - Возможна альтернативная сборка пакета, путем входа в контейнер и запуска скрипта /apps/<имя_проекта>/build/scripts/package.app
7. Переходим в консоль роутера и запускаем свою программу.
8. Смотрим логи.
9. Переходим к пункту 1. 

При необходимости можно просто скопировать уже собранный пакет на роутер или зайти в контейнер для работы (см. команды ниже);


### Описание параметров запуска утилиты **build/kotomka**
| Полная команда                 | Короткая<br/>команда | Краткое описание                        |
|--------------------------------|:--------------------:|:----------------------------------------|
| ./kotomka **build**            |       **-bl**        | собираем docker-образ                   |
| ./kotomka **rebuild**          |       **-rb**        | пересобираем docker-образ               |
| ./kotomka **make**             |       **-mk**        | сборка разрабатываемого пакета          |
| ./kotomka **copy**             |       **-cp**        | копирование пакета на роутер            |
| ./kotomka **term**             |       **-tr**        | подключение к контейнеру под **$USER**  |
| ./kotomka **root**             |       **-rt**        | подключение к контейнеру под **root**   |
| ./kotomka \<**cmd**> **debug** |       **-db**        | вывод отладочной информации при сборке  |
| ./kotomka **init**             |       **-in**        | возвращение к первоначальному состоянию |
| ./kotomka **help**             |       **-hl**        | отображает справку о командах           |



```
build       - сборка образа и последующий запуск сборки пакета. Для последующей сборки пакета необходимо 
              исполнить, либо команду 'kotomka make' на хостовой машине, либо, зайдя в собранный контейнер 
              при помощи команды 'kotomka term', выполнить скрипт /apps/<имя_проекта>/build/scripts/package.app

rebuild     - удаляем готовый образ и собираем его заново с последующим запуском сборки пакета.
make        - сборка пакета и копирование его на роутер на хостовой машине.
copy        - копирование уже собранного пакета на роутер. Порой необходима для передачи ранее собранного пакета. 

term        - подключение к docker-контейнеру без исполнения скриптов под текущим '$USER'. Обычный режим 
              разработки. Для сборки пакета в этом режиме необходимо, после внесенных изменений в код, 
              запустить скрипт /apps/<имя_проекта>/build/scripts/package.app для сборки пакета и копировании 
              в собранном виде на роутер. 
              
              ВАЖНО! Сборку пакета данным способом необходимо запускать, в случае наличия консольных запросов 
              в скрипте пост-установки /apps/<имя_пакета>/compile/postinst, в противном случае, при сборке 
              пакета с хостовой машины посредством команды 'kotomka make' будет не возможно отвечать на запросы 
              ввода данных из скрипта пост-установки.

root        - подключение к контейнеру без исполнения скриптов под root. Требуется только в том случае, если 
              есть потребность изменить что-либо в контейнере за пределами папки <имя_проекта>/ .   

debug       - дополнительный флаг к предыдущим аргументам для запуска в режиме отладки. Требутеся для вывода 
              отладочных сообщений в случае наличия ошибок. 
              Работает с следующими командами: build, rebuild и make.

init        - полное удаление исходных файлов в папках <имя_пакета>/{code,compile} и последующая иницилизация 
              данных в соотвествии с выбранным языком. Требуется в том случае, если есть необходимость, 
              например, поменять язык разработки.    
```


---

### Примечание:

1. Каждый из файлов, манифестов **Manifest.***, который находятся в папке **./build/.template**, при запуске сборки пакета, 
преобразуется в файл **Makefile** для соответствующего языка разработки и копируется в корень папки самой. 

2. Файловая структура в контейнере (в котором собирается пакет) соответствует структуре обозначенной выше,  
в разделе 'Структура файлов проекта', так как она папка проекта на хост машине монтируется внутрь контейнера.
Однако, помимо этого, в контейнере в папке **/apps**, также создается директория **entware** для сборки пакета. 
Ниже обозначены только те, папки директории **/apps/entware**, которые могут понадобиться для диагностики проблем.

3.
---

## Файловая структура в Docker-контейнере.
```
   /apps/
      ├──<имя_пакета>/                             - папка настоящего проекта примонтированная к хостовой машине.
      |
      └──/entware/                                 - папка, в котрой находятся файлы сборки пакета entware для Keenetic. 
          |      
          ├──.config                               - файл конфигурации enaware по которому строится меню по команде
          |                                          'make menuconfig'.                       
          ├──/package
          |      └──/utils
          |      |   └──/<имя_пакета>              - папка из которой собирается сам пакет. 
          |      |   |       |
          |      |   |       ├──Makefile           - манифест-файл по которому собирается пакет.
          |      |   |       └──/files             - папка, в котрой находятся все учавствующие в сборке файлы проекта, 
          |      |   |                               т.е. все файлы из 'Директорий c исходным кодом'. Вы должны 
          |      |   |                               самостоятельно позаботиться о том, чтобы эти папки и файлы в них, 
          |      |   |                               были корректно скопированы в соотвествующие папки на роутере,    
          |      |   |                               посредством редактирования файла манифеста Makefile в папке проекта 
          |      |   |                               /apps/<имя_пакета>/compile
          ~      ~   ~
          |
          ├──/bin
          |    ├─/targets         
          |    |     ├─/mipsel-3.4
          |    |     |      ├──generic-glibc
          |    |     |      |     └──/packages     - папка в которой располагаются все собранные ipk пакеты  
          ~    ~     ~      ~ 
```
